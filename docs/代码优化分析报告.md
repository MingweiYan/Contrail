# Contrail ä»£ç ä¼˜åŒ–åˆ†ææŠ¥å‘Š

## æ–‡ä»¶åˆ—è¡¨ä¸åˆ†æçŠ¶æ€

### æ ¸å¿ƒæ–‡ä»¶
- [x] lib/core/di/injection_container.dart
- [x] lib/main.dart
- [x] lib/core/routing/app_router.dart

### æœåŠ¡å±‚
- [x] lib/shared/services/notification_service.dart
- [x] lib/shared/services/habit_statistics_service.dart

### çŠ¶æ€ç®¡ç†
- [x] lib/features/habit/presentation/providers/habit_provider.dart
- [x] lib/features/statistics/presentation/providers/statistics_provider.dart

### å…¶ä»–éœ€è¦åˆ†æçš„æ–‡ä»¶
- [x] lib/features/habit/data/repositories/habit_repository.dart
- [x] lib/features/habit/data/repositories/hive_habit_repository.dart
- [x] lib/shared/models/habit.dart
- [x] lib/shared/models/theme_model.dart
- [x] lib/shared/models/goal_type.dart
- [x] lib/shared/models/cycle_type.dart
- [x] lib/shared/models/goal_type_adapter.dart
- [x] lib/shared/models/cycle_type_adapter.dart
- [x] lib/shared/models/duration_adapter.dart
- [x] lib/shared/utils/logger.dart
- [x] lib/shared/utils/theme_helper.dart
- [x] lib/shared/utils/icon_helper.dart
- [x] lib/shared/utils/debug_menu_manager.dart
- [x] lib/shared/utils/habit_data_generator.dart
- [x] lib/navigation/main_tab_page.dart
- [x] lib/core/state/focus_state.dart
- [x] lib/core/state/theme_provider.dart
- [x] lib/core/services/background_timer_service.dart
- [x] lib/core/routing/app_router.dart
- [x] lib/features/habit/presentation/pages/habit_management_page.dart
- [x] lib/features/habit/presentation/pages/habit_tracking_page.dart
- [x] lib/features/habit/presentation/routes/habit_routes.dart
- [x] lib/features/habit/domain/use_cases/get_habits_use_case.dart
- [x] lib/features/habit/domain/use_cases/add_habit_use_case.dart
- [x] lib/features/profile/presentation/pages/data_backup_page.dart
- [x] lib/features/profile/presentation/pages/profile_page.dart
- [x] lib/features/profile/presentation/pages/theme_selection_page.dart
- [x] lib/features/profile/presentation/routes/profile_routes.dart
- [x] lib/features/statistics/presentation/pages/statistics_page.dart
- [x] lib/features/statistics/presentation/routes/statistics_routes.dart
- [x] lib/features/statistics/presentation/widgets/statistics_chart_widget.dart
- [x] lib/features/statistics/presentation/widgets/calendar_view_widget.dart
- [x] lib/features/statistics/presentation/widgets/timeline_view_widget.dart
- [x] lib/features/focus/presentation/pages/focus_selection_page.dart
- [x] lib/features/focus/presentation/routes/focus_routes.dart
- [x] lib/features/splash/presentation/pages/splash_screen.dart
- æ³¨ï¼šfocus_provider.dartå’Œprofile_provider.dartæ–‡ä»¶ä¸å­˜åœ¨

## æ¶æ„åˆ†æä¸ä¼˜åŒ–å»ºè®®

### å½“å‰æ¶æ„æ¦‚è¿°

é€šè¿‡å¯¹å·²åˆ†ææ–‡ä»¶çš„æ£€æŸ¥ï¼Œå‘ç°Contrailåº”ç”¨é‡‡ç”¨äº†æ··åˆæ¶æ„æ¨¡å¼ï¼Œèåˆäº†ä¸€äº›é¢†åŸŸé©±åŠ¨è®¾è®¡çš„æ€æƒ³ï¼š

- **ä¾èµ–æ³¨å…¥**ï¼šä½¿ç”¨GetItå®ç°ä¾èµ–ç®¡ç†
- **çŠ¶æ€ç®¡ç†**ï¼šä¸»è¦ä½¿ç”¨Provideræ¨¡å¼ï¼Œéƒ¨åˆ†ç»„ä»¶ç›´æ¥åœ¨é¡µé¢ä¸­ç®¡ç†çŠ¶æ€
- **è·¯ç”±ç®¡ç†**ï¼šä½¿ç”¨GoRouterå®ç°é¡µé¢å¯¼èˆª
- **æ•°æ®æŒä¹…åŒ–**ï¼šä½¿ç”¨Hiveä½œä¸ºæœ¬åœ°æ•°æ®åº“
- **é¢†åŸŸå±‚**ï¼šå¼•å…¥äº†UseCaseæ¨¡å¼å¤„ç†ä¸šåŠ¡é€»è¾‘
- **åˆ†å±‚ç»“æ„**ï¼šæœ‰ä¸€å®šçš„åˆ†å±‚æ„è¯†ï¼ˆdataã€domainã€presentationï¼‰ï¼Œä½†å®ç°ä¸å¤Ÿä¸€è‡´

### ä¸»è¦æ¶æ„é—®é¢˜

1. **ä¸šåŠ¡é€»è¾‘ä¸UIçŠ¶æ€æ··åˆ**
   - Providerç±»ï¼ˆå¦‚habit_provider.dartï¼‰æ—¢ç®¡ç†çŠ¶æ€åˆåŒ…å«å¤§é‡ä¸šåŠ¡é€»è¾‘
   - ç¼ºä¹æ¸…æ™°çš„èŒè´£åˆ†ç¦»
   - æ³¨ï¼šå·²å¼€å§‹å¼•å…¥UseCaseæ¨¡å¼å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œä½†å®ç°ä¸å¤Ÿä¸€è‡´
   - statistics_page.dartä¸­åŒ…å«ç»Ÿè®¡è®¡ç®—é€»è¾‘ï¼Œåº”ç§»è‡³æœåŠ¡å±‚

2. **ç¼ºä¹æ¥å£æŠ½è±¡**
   - æœåŠ¡ç±»ç›´æ¥å®ç°å…·ä½“åŠŸèƒ½ï¼Œæ²¡æœ‰å¯¹åº”çš„æŠ½è±¡æ¥å£
   - ä¸åˆ©äºæµ‹è¯•å’Œæ›¿æ¢å®ç°
   - æ³¨ï¼šæ•°æ®ä»“åº“å±‚å·²ç»æœ‰è‰¯å¥½çš„æŠ½è±¡æ¥å£ï¼ˆå¦‚HabitRepositoryï¼‰

3. **æŒä¹…åŒ–é€»è¾‘æ··åˆåœ¨çŠ¶æ€ç±»ä¸­**
   - ThemeProviderç­‰ç±»ç›´æ¥å¤„ç†SharedPreferencesæ“ä½œ
   - ç¼ºä¹ä¸“é—¨çš„æ•°æ®æŒä¹…åŒ–æœåŠ¡å±‚

4. **ä¸»é¢˜ç³»ç»Ÿè®¾è®¡é—®é¢˜**
   - ThemeHelperä½¿ç”¨é™æ€æ–¹æ³•è®¾è®¡ï¼Œéš¾ä»¥æµ‹è¯•å’Œæ‰©å±•
   - ä¸»é¢˜ç›¸å…³åŠŸèƒ½åˆ†æ•£åœ¨å¤šä¸ªç±»ä¸­ï¼ˆThemeProviderã€ThemeHelperã€theme_modelï¼‰
   - ç¼ºä¹ç»Ÿä¸€çš„ä¸»é¢˜è®¿é—®æ¥å£

5. **é”™è¯¯å¤„ç†åˆ†æ•£**
   - é”™è¯¯å¤„ç†é€»è¾‘æ•£å¸ƒåœ¨å„ä¸ªç±»ä¸­
   - ç¼ºä¹ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ç­–ç•¥

4. **æ—¥å¿—ç³»ç»Ÿ**
   - æ—¥å¿—ç³»ç»Ÿå·²ç»å°è£…ï¼Œä½†ç¼ºå°‘ä¸é”™è¯¯å¤„ç†çš„é›†æˆ
   - æ—¥å¿—æ ¼å¼å’Œçº§åˆ«æ§åˆ¶å·²å®ç°ï¼Œä½†å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–

5. **ä»£ç ç»“æ„é—®é¢˜**
   - éƒ¨åˆ†æ–¹æ³•è¿‡é•¿ï¼ŒèŒè´£è¿‡å¤š
   - ä»£ç é‡å¤ï¼Œå¦‚habit_provider.dartä¸­çš„ä¹ æƒ¯å¯¹è±¡åˆ›å»ºé€»è¾‘

6. **ç»„ä»¶é—´é€šä¿¡é—®é¢˜**
   - main_tab_page.dartä¸­ä½¿ç”¨äº†é™æ€æ–¹æ³•å’Œä¾èµ–æŸ¥æ‰¾æ¥æ›´æ–°æ ‡ç­¾é¡µï¼Œè¿åäº†ä¾èµ–æ³¨å…¥åŸåˆ™
   - å­˜åœ¨æ³¨é‡Šæ‰çš„ä»£ç ï¼Œå½±å“ä»£ç å¯è¯»æ€§

7. **æ¶æ„ä¸€è‡´æ€§é—®é¢˜**
   - ä¸åŒåŠŸèƒ½æ¨¡å—çš„å®ç°æ–¹å¼ä¸ä¸€è‡´ï¼ˆæœ‰äº›ä½¿ç”¨Providerï¼Œæœ‰äº›å¯èƒ½ç›´æ¥åœ¨é¡µé¢ä¸­å¤„ç†é€»è¾‘ï¼‰

### 8. **å…¨å±€çŠ¶æ€ç®¡ç†é—®é¢˜**
   - focus_state.dartä½¿ç”¨äº†æ··åˆçš„çŠ¶æ€ç®¡ç†æ–¹å¼
   - åŒ…å«å¤§é‡çŠ¶æ€å’Œä¸šåŠ¡é€»è¾‘ï¼ŒèŒè´£è¿‡é‡
   - ä½¿ç”¨äº†è§‚å¯Ÿè€…æ¨¡å¼ä½†å®ç°ä¸å¤Ÿä¼˜é›…
   - å­˜åœ¨æ³¨é‡Šæ‰çš„ä»£ç å’Œå¤æ‚çš„å¼‚æ­¥æ“ä½œå¤„ç†
   - habit_tracking_page.dartç›´æ¥ä½¿ç”¨æœåŠ¡å®šä½å™¨è·å–FocusStateï¼Œè¿åä¾èµ–æ³¨å…¥åŸåˆ™
   - habit_tracking_page.dartæ··åˆäº†UIé€»è¾‘å’Œä¸šåŠ¡é€»è¾‘

### 9. **æ•°æ®å¤‡ä»½æ¶æ„é—®é¢˜**
   - data_backup_page.dartä¸­æ•°æ®å¤‡ä»½/æ¢å¤é€»è¾‘ä¸UIæ··åˆ
   - ç¼ºä¹ä¸“é—¨çš„æ•°æ®å¤‡ä»½æœåŠ¡å±‚æŠ½è±¡
   - æƒé™å¤„ç†ã€æ–‡ä»¶æ“ä½œã€æ•°æ®è½¬æ¢ç­‰å¤šç§èŒè´£æ··åˆåœ¨åŒä¸€é¡µé¢

10. **ç”¨æˆ·é…ç½®ç®¡ç†é—®é¢˜**
    - profile_page.dartç›´æ¥å¤„ç†SharedPreferencesæ“ä½œ
    - ç¼ºä¹ç”¨æˆ·é…ç½®ç®¡ç†çš„æœåŠ¡å±‚æŠ½è±¡
    - ä¸ªäººèµ„æ–™æ•°æ®ä¸UIæ··åˆ

### 11. **ä¾èµ–æ³¨å…¥ç»„ç»‡é—®é¢˜**
   - æ‰€æœ‰ä¾èµ–åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­æ³¨å†Œï¼Œç¼ºä¹æ¨¡å—åˆ†ç±»

12. **è·¯ç”±æ¶æ„é—®é¢˜**
    - å¤šä¸ªè·¯ç”±æ˜ å°„åˆ°åŒä¸€ä¸ªé¡µé¢ç»„ä»¶ï¼ˆå¦‚profile_routes.dartä¸­çš„å¤šä¸ªè·¯å¾„éƒ½æŒ‡å‘ProfilePageï¼‰
    - è·¯ç”±å‚æ•°ä¼ é€’æ–¹å¼ä¸ä¸€è‡´ï¼ˆæœ‰äº›ä½¿ç”¨extraï¼Œæœ‰äº›æ²¡æœ‰å‚æ•°ï¼‰
    - è·¯ç”±é…ç½®ä¸é¡µé¢ç»„ä»¶è€¦åˆåº¦é«˜
    - ç¼ºä¹è·¯ç”±å®ˆå«å’Œç»Ÿä¸€çš„å¯¼èˆªæœåŠ¡

### ä¼˜åŒ–å»ºè®®

#### 1. æœåŠ¡å±‚ä¼˜åŒ–

1.1 **åˆ›å»ºæœåŠ¡æŠ½è±¡æ¥å£**
```dart
// ç¤ºä¾‹ï¼šä¸ºNotificationServiceåˆ›å»ºæ¥å£
abstract class INotificationService {
  Future<void> initialize();
  Future<bool> checkNotificationPermission();
  Future<void> showCountdownCompleteNotification(String habitName);
}

class NotificationService implements INotificationService {
  // å®ç°æ¥å£æ–¹æ³•
}
```

1.2 **æ‹†åˆ†å¤æ‚æœåŠ¡**
- å°†habit_statistics_service.dartæ‹†åˆ†ä¸ºæ›´å°çš„æœåŠ¡ç±»
- æ¯ä¸ªç±»ä¸“æ³¨äºå•ä¸€èŒè´£

#### 2. çŠ¶æ€ç®¡ç†ä¼˜åŒ–

2.1 **åˆ†ç¦»ä¸šåŠ¡é€»è¾‘ä¸çŠ¶æ€ç®¡ç†**
- å¼•å…¥UseCaseæ¨¡å¼å¤„ç†ä¸šåŠ¡é€»è¾‘
- Providerä»…è´Ÿè´£çŠ¶æ€ç®¡ç†å’Œé€šçŸ¥UIæ›´æ–°

2.2 **ç»Ÿä¸€çŠ¶æ€æ¨¡å‹**
- åˆ›å»ºé€šç”¨çš„çŠ¶æ€æ¨¡å‹ç±»
- æ ‡å‡†åŒ–åŠ è½½ã€æˆåŠŸã€é”™è¯¯ç­‰çŠ¶æ€å¤„ç†

#### 3. é”™è¯¯å¤„ç†ä¼˜åŒ–

3.1 **å®ç°ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶**
- å®šä¹‰åº”ç”¨çº§å¼‚å¸¸å±‚æ¬¡ç»“æ„
- åˆ›å»ºé”™è¯¯å¤„ç†å™¨ç»Ÿä¸€ç®¡ç†é”™è¯¯

#### 3. ä¾èµ–æ³¨å…¥ä¼˜åŒ–

3.1 **æŒ‰æ¨¡å—ç»„ç»‡ä¾èµ–æ³¨å†Œ**
- æŒ‰åŠŸèƒ½æ¨¡å—åˆ†ç»„æ³¨å†Œä¾èµ–
- æé«˜ä¾èµ–ç®¡ç†çš„å¯è¯»æ€§å’Œç»´æŠ¤æ€§

3.2 **ä¼˜åŒ–æ•°æ®å±‚åˆå§‹åŒ–**
- å°†Hiveåˆå§‹åŒ–é€»è¾‘æå–åˆ°ä¸“é—¨çš„æœåŠ¡ä¸­
- æ”¹è¿›é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- åˆ†ç¦»é€‚é…å™¨æ³¨å†Œå’Œæ•°æ®åº“æ‰“å¼€é€»è¾‘

3.3 **ä¾èµ–æ³¨å†Œé¡ºåºä¼˜åŒ–**
- ç¡®ä¿ä¾èµ–æ³¨å†Œé¡ºåºç¬¦åˆä¾èµ–å…³ç³»
- é¿å…å¾ªç¯ä¾èµ–

#### 5. ä»£ç è´¨é‡ä¼˜åŒ–

5.1 **é‡æ„é•¿æ–¹æ³•**
- æå–è¾…åŠ©æ–¹æ³•ï¼Œå‡å°‘åµŒå¥—
- ä½¿ç”¨æå‰è¿”å›æ¨¡å¼

5.2 **æ¶ˆé™¤ä»£ç é‡å¤**
- æå–å…¬å…±é€»è¾‘åˆ°è¾…åŠ©æ–¹æ³•
- é¿å…å¤åˆ¶ç²˜è´´ä»£ç 

5.3 **æ¨¡å‹ç±»ä¼˜åŒ–**
- é¿å…åœ¨æ¨¡å‹ç±»ä¸­åŒ…å«è¿‡å¤šä¸šåŠ¡é€»è¾‘
- è€ƒè™‘å°†ä¸šåŠ¡é€»è¾‘ä»æ¨¡å‹ç±»ç§»è‡³æœåŠ¡å±‚
- æ¨¡å‹ç±»åº”ä¸“æ³¨äºæ•°æ®ç»“æ„å’ŒåŸºæœ¬æ“ä½œ

5.4 **ç»„ä»¶é—´é€šä¿¡ä¼˜åŒ–**
- é¿å…ä½¿ç”¨é™æ€æ–¹æ³•å’Œä¾èµ–æŸ¥æ‰¾è¿›è¡Œç»„ä»¶é—´é€šä¿¡
- æ¨èä½¿ç”¨çŠ¶æ€ç®¡ç†æˆ–äº‹ä»¶æ€»çº¿ç­‰æ›´ä¼˜é›…çš„é€šä¿¡æ–¹å¼
- ç§»é™¤æ³¨é‡Šæ‰çš„ä»£ç ï¼Œä¿æŒä»£ç æ•´æ´

## è¯¦ç»†ä¼˜åŒ–å»ºè®®

### 1. æœåŠ¡å±‚è¯¦ç»†ä¼˜åŒ–

#### NotificationServiceä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- æ–¹æ³•è¿‡é•¿ï¼Œå¦‚showCountdownCompleteNotificationåŒ…å«å¤§é‡é€»è¾‘
- é”™è¯¯å¤„ç†ç®€å•ï¼Œç¼ºä¹æ¢å¤æœºåˆ¶

ä¼˜åŒ–å»ºè®®ï¼š
```dart
Future<void> showCountdownCompleteNotification(String habitName) async {
  try {
    if (!await _checkAndRequestPermission()) {
      return; // æå‰è¿”å›ï¼Œå‡å°‘åµŒå¥—
    }
    
    await _displayNotification(habitName);
    logger.debug('ä¸“æ³¨å®Œæˆé€šçŸ¥å‘é€æˆåŠŸ');
  } catch (e) {
    _handleNotificationError(e);
  }
}

// æå–è¾…åŠ©æ–¹æ³•
Future<bool> _checkAndRequestPermission() async { /* ... */ }
Future<void> _displayNotification(String habitName) async { /* ... */ }
void _handleNotificationError(dynamic e) { /* ... */ }
```

#### HabitStatisticsServiceä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- ç±»è¿‡å¤§ï¼ŒåŒ…å«å¤šç§ç»Ÿè®¡è®¡ç®—é€»è¾‘
- ç¼ºä¹çµæ´»æ€§å’Œå¯æµ‹è¯•æ€§

ä¼˜åŒ–å»ºè®®ï¼š
- æ‹†åˆ†ä¸ºæ ¸å¿ƒæœåŠ¡å’Œä¸“ç”¨è®¡ç®—ç±»
- æå–çº¯å‡½æ•°è¿›è¡Œç»Ÿè®¡è®¡ç®—

### 2. çŠ¶æ€ç®¡ç†è¯¦ç»†ä¼˜åŒ–

#### HabitProviderä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†æ··åˆ
- ä»£ç é‡å¤ï¼Œå¦‚ä¹ æƒ¯å¯¹è±¡åˆ›å»ºé€»è¾‘

ä¼˜åŒ–å»ºè®®ï¼š
```dart
// æŠ½å–ä¹ æƒ¯åˆ›å»ºé€»è¾‘
Habit _createHabit(Habit habit) {
  return Habit(
    id: habit.id,
    name: habit.name,
    // å…¶ä»–å­—æ®µ...
    colorValue: habit.colorValue,
    trackingDurations: Map.from(habit.trackingDurations),
    dailyCompletionStatus: Map.from(habit.dailyCompletionStatus),
  );
}

// ä½¿ç”¨ç”¨ä¾‹å¤„ç†ä¸šåŠ¡é€»è¾‘
Future<void> addHabit(Habit habit) async {
  _isLoading = true;
  notifyListeners();
  
  try {
    final newHabit = await _addHabitUseCase.execute(habit);
    _habits.add(newHabit);
  } catch (e) {
    _errorMessage = 'æ·»åŠ ä¹ æƒ¯å¤±è´¥: $e';
  } finally {
    _isLoading = false;
    notifyListeners();
  }
}
```

### 3. ä¾èµ–æ³¨å…¥è¯¦ç»†ä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- æ‰€æœ‰ä¾èµ–åœ¨ä¸€ä¸ªåœ°æ–¹æ³¨å†Œï¼Œéš¾ä»¥ç®¡ç†

ä¼˜åŒ–å»ºè®®ï¼š
```dart
void initDependencies() {
  // æŒ‰æ¨¡å—åˆ†ç»„æ³¨å†Œ
  _initCoreServices();
  _initDataLayer();
  _initFeatureModules();
}

void _initCoreServices() {
  // æ ¸å¿ƒæœåŠ¡æ³¨å†Œ
  sl.registerLazySingleton(() => Logger());
  sl.registerLazySingleton<INotificationService>(() => NotificationService());
}

void _initDataLayer() {
  // æ•°æ®å±‚ä¾èµ–æ³¨å†Œ
  sl.registerLazySingleton<HabitRepository>(() => HabitRepositoryImpl());
}

void _initFeatureModules() {
  // åŠŸèƒ½æ¨¡å—ä¾èµ–æ³¨å†Œ
  _initHabitModule();
  _initStatisticsModule();
}

void _initHabitModule() {
  // ä¹ æƒ¯æ¨¡å—ä¾èµ–æ³¨å†Œ
  sl.registerFactory(() => GetHabitsUseCase(sl()));
  sl.registerFactory(() => AddHabitUseCase(sl()));
  sl.registerFactory(() => HabitProvider(
    getHabitsUseCase: sl(),
    addHabitUseCase: sl(),
  ));
}
```

### 4. é”™è¯¯å¤„ç†è¯¦ç»†ä¼˜åŒ–

å®ç°ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶ï¼š
```dart
// å®šä¹‰åº”ç”¨å¼‚å¸¸
abstract class AppException implements Exception {
  final String message;
  final StackTrace? stackTrace;
  
  const AppException(this.message, [this.stackTrace]);
}

class NetworkException extends AppException { /* ... */ }
class DataException extends AppException { /* ... */ }

// ç»Ÿä¸€é”™è¯¯å¤„ç†å™¨
class ErrorHandler {
  static void handleError(AppException exception) {
    logger.error(exception.message, exception, exception.stackTrace);
    // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
    // é”™è¯¯ä¸ŠæŠ¥
  }
}
```

## å®æ–½è®¡åˆ’

### åˆ†é˜¶æ®µå®æ–½ç­–ç•¥

1. **ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½ä¼˜åŒ–**
   - åˆ›å»ºæœåŠ¡æŠ½è±¡æ¥å£
   - å®ç°ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
   - ä¼˜åŒ–ä¾èµ–æ³¨å…¥ç»“æ„

2. **ç¬¬äºŒé˜¶æ®µï¼šé‡æ„æ ¸å¿ƒæœåŠ¡**
   - æ‹†åˆ†å¤æ‚æœåŠ¡
   - é‡æ„é•¿æ–¹æ³•å’Œé‡å¤ä»£ç 

3. **ç¬¬ä¸‰é˜¶æ®µï¼šçŠ¶æ€ç®¡ç†ä¼˜åŒ–**
   - å¼•å…¥UseCaseæ¨¡å¼
   - ç»Ÿä¸€çŠ¶æ€æ¨¡å‹

4. **ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•å’ŒéªŒè¯**
   - ä¸ºä¼˜åŒ–åçš„ä»£ç ç¼–å†™æµ‹è¯•
   - éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§å’Œæ€§èƒ½

### ä¼˜å…ˆçº§å»ºè®®

1. æœåŠ¡å±‚æŠ½è±¡æ¥å£ - é«˜ä¼˜å…ˆçº§ï¼Œä½é£é™©
2. ç»Ÿä¸€é”™è¯¯å¤„ç† - é«˜ä¼˜å…ˆçº§ï¼Œä¸­ç­‰é£é™©
3. ä¾èµ–æ³¨å…¥ä¼˜åŒ– - ä¸­ä¼˜å…ˆçº§ï¼Œä½é£é™©
4. æœåŠ¡é‡æ„ - ä¸­ä¼˜å…ˆçº§ï¼Œä¸­ç­‰é£é™©
5. çŠ¶æ€ç®¡ç†ä¼˜åŒ– - ä½ä¼˜å…ˆçº§ï¼Œé«˜é£é™©

### 5. ç»„ä»¶é—´é€šä¿¡ä¼˜åŒ–

#### main_tab_page.dartä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- ä½¿ç”¨é™æ€æ–¹æ³•å’Œä¾èµ–æŸ¥æ‰¾æ›´æ–°æ ‡ç­¾é¡µï¼Œè¿åä¾èµ–æ³¨å…¥åŸåˆ™
- å­˜åœ¨å¤§é‡æ³¨é‡Šæ‰çš„ä»£ç 
- ç›´æ¥ä½¿ç”¨FocusState()åˆ›å»ºæ–°å®ä¾‹ï¼Œæ²¡æœ‰é€šè¿‡ä¾èµ–æ³¨å…¥è·å–

ä¼˜åŒ–å»ºè®®ï¼š
```dart
class MainTabPage extends StatefulWidget {
  const MainTabPage({super.key});

  @override
  State<MainTabPage> createState() => _MainTabPageState();
}

class _MainTabPageState extends State<MainTabPage> with WidgetsBindingObserver {
  int _selectedIndex = 0;
  // é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥focusState
  final FocusState focusState;
  
  _MainTabPageState({required this.focusState});
  
  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);
  }
  
  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    super.didChangeAppLifecycleState(state);
    logger.debug('ğŸ”„  åº”ç”¨ä»åå°å”¤é†’');
    
    if (state == AppLifecycleState.resumed) {
      _handleAppResumed();
    }
  }
  
  // æå–å¤„ç†åº”ç”¨æ¢å¤çš„é€»è¾‘åˆ°å•ç‹¬æ–¹æ³•
  void _handleAppResumed() {
    // æ£€æŸ¥ä¸“æ³¨çŠ¶æ€å¹¶æ›´æ–°æ—¶é—´
    focusState.appResumed();
    
    if (focusState.focusStatus != FocusStatus.stop && focusState.currentFocusHabit != null) {
      // ä½¿ç”¨è·¯ç”±å¯¼èˆªè€Œä¸æ˜¯ç›´æ¥åˆ›å»ºé¡µé¢
      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => HabitTrackingPage(habit: focusState.currentFocusHabit!),
        ),
      );
      logger.debug('ğŸ”„  å¯¼èˆªåˆ°ä¸“æ³¨é¡µé¢');
    }
  }
}

// åœ¨ä¾èµ–æ³¨å…¥ä¸­æ³¨å†Œ
sl.registerFactory(() => MainTabPage(
  focusState: sl(),
));
```

### 7. å…¨å±€çŠ¶æ€ç®¡ç†ä¼˜åŒ–

#### focus_state.dartä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- èŒè´£è¿‡é‡ï¼ŒåŒ…å«çŠ¶æ€ç®¡ç†å’Œä¸šåŠ¡é€»è¾‘
- è§‚å¯Ÿè€…æ¨¡å¼å®ç°ä¸å¤Ÿä¼˜é›…
- å¤æ‚çš„å¼‚æ­¥æ“ä½œå¤„ç†
- å­˜åœ¨æ³¨é‡Šæ‰çš„ä»£ç 
- ç›´æ¥ä½¿ç”¨æœåŠ¡å®šä½å™¨è·å–ä¾èµ–

ä¼˜åŒ–å»ºè®®ï¼š

1. **åˆ†ç¦»çŠ¶æ€å’Œä¸šåŠ¡é€»è¾‘**ï¼š
```dart
// ä¸“æ³¨çŠ¶æ€æ¥å£
abstract class IFocusState {
  FocusStatus get focusStatus;
  Habit? get currentFocusHabit;
  Duration get elapsedTime;
  TrackingMode? get focusMode;
  
  void startFocus(Habit habit, TrackingMode mode, [Duration initialTime = Duration.zero]);
  void pauseFocus();
  void resumeFocus();
  void stopFocus();
  void appResumed();
  
  // è§‚å¯Ÿè€…æ¨¡å¼æ¥å£
  void addListener(Function(FocusStatus) listener);
  void removeListener(Function(FocusStatus) listener);
  void addTimeUpdateListener(Function(Duration) listener);
  void removeTimeUpdateListener(Function(Duration) listener);
}

// å®ç°ç±»
class FocusStateImpl implements IFocusState {
  // é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨æœåŠ¡å®šä½å™¨
  final BackgroundTimerService _backgroundTimerService;
  final NotificationService _notificationService;
  
  FocusStateImpl(this._backgroundTimerService, this._notificationService) {
    _backgroundTimerService.setFocusState(this);
    _backgroundTimerService.start();
  }
  
  // çŠ¶æ€å’Œæ–¹æ³•å®ç°...
  
  // å¤„ç†å€’è®¡æ—¶ç»“æŸ - ä½¿ç”¨æ›´æ¸…æ™°çš„å¼‚æ­¥å¤„ç†
  Future<void> _handleCountdownEnd() async {
    try {
      await _backgroundTimerService.stopTimer();
      _isCountdownEnded = true;
      
      // å‘é€é€šçŸ¥
      if (_currentFocusHabit != null) {
        await _notificationService.showCountdownCompleteNotification(_currentFocusHabit!.name);
      }
      
      // é€šçŸ¥ç›‘å¬å™¨
      _notifyCountdownEnd();
    } catch (e) {
      logger.error('å¤„ç†å€’è®¡æ—¶ç»“æŸå¤±è´¥', e);
    }
  }
}
```

2. **ä¼˜åŒ–ä¾èµ–æ³¨å…¥**ï¼š
```dart
// åœ¨injection_container.dartä¸­æ³¨å†Œ
void _initCoreState() {
  // æ³¨å†Œåå°è®¡æ—¶å™¨æœåŠ¡
  sl.registerSingleton<BackgroundTimerService>(BackgroundTimerService());
  
  // æ³¨å†Œä¸“æ³¨çŠ¶æ€æœåŠ¡
  sl.registerSingleton<IFocusState>(
    FocusStateImpl(
      sl<BackgroundTimerService>(),
      sl<NotificationService>(),
    ),
  );
}
```

3. **ä½¿ç”¨Streamæ›¿ä»£è‡ªå®šä¹‰è§‚å¯Ÿè€…æ¨¡å¼**ï¼š
```dart
class FocusStateWithStreams implements IFocusState {
  final _statusController = StreamController<FocusStatus>.broadcast();
  final _timeController = StreamController<Duration>.broadcast();
  final _countdownEndController = StreamController<void>.broadcast();
  
  // è·å–Streamç”¨äºç›‘å¬
  Stream<FocusStatus> get statusStream => _statusController.stream;
  Stream<Duration> get timeStream => _timeController.stream;
  Stream<void> get countdownEndStream => _countdownEndController.stream;
  
  // æ›´æ–°çŠ¶æ€å¹¶é€šçŸ¥
  void _updateStatus(FocusStatus status) {
    _focusStatus = status;
    _statusController.add(status);
  }
  
  // æ¸…ç†èµ„æº
  void dispose() {
    _statusController.close();
    _timeController.close();
    _countdownEndController.close();
  }
}
```

4. **åœ¨Widgetä¸­ä½¿ç”¨StreamBuilder**ï¼š
```dart
class FocusTrackingPage extends StatelessWidget {
  final IFocusState focusState;
  
  FocusTrackingPage({required this.focusState});
  
  @override
  Widget build(BuildContext context) {
    return StreamBuilder<Duration>(
      stream: focusState.timeStream,
      builder: (context, snapshot) {
        final elapsedTime = snapshot.data ?? Duration.zero;
        return Text(formatDuration(elapsedTime));
      },
    );
  }
}
```

### 8. æ•°æ®å¤‡ä»½æœåŠ¡ä¼˜åŒ–

#### data_backup_page.dartä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- æ•°æ®å¤‡ä»½/æ¢å¤é€»è¾‘ä¸UIæ··åˆ
- ç¼ºä¹ä¸“é—¨çš„æ•°æ®å¤‡ä»½æœåŠ¡å±‚æŠ½è±¡
- æƒé™å¤„ç†ã€æ–‡ä»¶æ“ä½œã€æ•°æ®è½¬æ¢ç­‰å¤šç§èŒè´£æ··åˆåœ¨åŒä¸€é¡µé¢
- ç›´æ¥ä½¿ç”¨Hiveè€Œä¸æ˜¯é€šè¿‡Repositoryæ¥å£æ“ä½œæ•°æ®

ä¼˜åŒ–å»ºè®®ï¼š
```dart
// 1. åˆ›å»ºæ•°æ®å¤‡ä»½æœåŠ¡æ¥å£
abstract class IDataBackupService {
  Future<void> backupData(String filePath);
  Future<void> restoreData(String filePath);
  Future<List<BackupFileInfo>> getLocalBackupFiles();
  Future<bool> checkAndRequestStoragePermission();
}

// 2. å®ç°æ•°æ®å¤‡ä»½æœåŠ¡
class DataBackupService implements IDataBackupService {
  final HabitRepository _habitRepository;
  final SharedPreferences _preferences;
  
  DataBackupService(this._habitRepository, this._preferences);
  
  @override
  Future<void> backupData(String filePath) async {
    try {
      // è·å–æ‰€æœ‰ä¹ æƒ¯æ•°æ®
      final habits = await _habitRepository.getHabits();
      
      // è½¬æ¢ä¸ºJSON
      final backupData = {
        'habits': habits.map((h) => _habitToJson(h)).toList(),
        'settings': _getSettings(),
        'timestamp': DateTime.now().millisecondsSinceEpoch,
        'version': '1.0.0'
      };
      
      // å†™å…¥æ–‡ä»¶
      final file = File(filePath);
      await file.writeAsString(jsonEncode(backupData));
    } catch (e) {
      logger.error('å¤‡ä»½æ•°æ®å¤±è´¥', e);
      throw DataBackupException('å¤‡ä»½æ•°æ®å¤±è´¥');
    }
  }
  
  @override
  Future<void> restoreData(String filePath) async {
    // æ¢å¤æ•°æ®çš„å®ç°
  }
  
  // è¾…åŠ©æ–¹æ³•
  Map<String, dynamic> _habitToJson(Habit habit) {
    // è½¬æ¢é€»è¾‘
  }
  
  Map<String, dynamic> _getSettings() {
    // è·å–è®¾ç½®çš„é€»è¾‘
  }
}

// 3. åœ¨ä¾èµ–æ³¨å…¥ä¸­æ³¨å†Œ
void _initDataServices() {
  sl.registerSingletonAsync<SharedPreferences>(
    () => SharedPreferences.getInstance(),
  );
  
  sl.registerSingleton<IDataBackupService>(
    DataBackupService(
      sl(),
      sl(),
    ),
  );
}

// 4. ç®€åŒ–é¡µé¢ç»„ä»¶
class DataBackupPage extends StatefulWidget {
  const DataBackupPage({super.key});
  
  @override
  State<DataBackupPage> createState() => _DataBackupPageState();
}

class _DataBackupPageState extends State<DataBackupPage> {
  final IDataBackupService _backupService = sl();
  List<BackupFileInfo> _backupFiles = [];
  bool _isLoading = false;
  
  @override
  void initState() {
    super.initState();
    _checkPermissionAndLoadFiles();
  }
  
  Future<void> _checkPermissionAndLoadFiles() async {
    final hasPermission = await _backupService.checkAndRequestStoragePermission();
    if (hasPermission) {
      _loadBackupFiles();
    }
  }
  
  Future<void> _loadBackupFiles() async {
    setState(() => _isLoading = true);
    try {
      _backupFiles = await _backupService.getLocalBackupFiles();
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('åŠ è½½å¤‡ä»½æ–‡ä»¶å¤±è´¥')),
      );
    } finally {
      setState(() => _isLoading = false);
    }
  }
}
### 9. ä¸“æ³¨åŠŸèƒ½ä¼˜åŒ–

#### habit_tracking_page.dartä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- ç›´æ¥ä½¿ç”¨æœåŠ¡å®šä½å™¨è·å–FocusStateï¼Œè¿åä¾èµ–æ³¨å…¥åŸåˆ™
- UIé€»è¾‘å’Œä¸šåŠ¡é€»è¾‘æ··åˆ
- ç”Ÿå‘½å‘¨æœŸç®¡ç†å¤æ‚ï¼Œæ‰‹åŠ¨æ·»åŠ /ç§»é™¤ç›‘å¬å™¨
- çŠ¶æ€ç®¡ç†åˆ†æ•£åœ¨é¡µé¢å’Œå…¨å±€FocusStateä¸­

ä¼˜åŒ–å»ºè®®ï¼š
```dart
// 1. é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
class HabitTrackingPage extends StatefulWidget {
  final Habit habit;
  final IFocusState focusState;
  final HabitProvider habitProvider;

  const HabitTrackingPage({
    super.key,
    required this.habit,
    required this.focusState,
    required this.habitProvider,
  });

  @override
  State<HabitTrackingPage> createState() => _HabitTrackingPageState();
}

class _HabitTrackingPageState extends State<HabitTrackingPage> {
  bool _showSettings = true;
  FocusStatus _focusStatus = FocusStatus.stop;
  Duration _elapsedTime = Duration.zero;
  int _timerDuration = 30;
  TrackingMode _selectedMode = TrackingMode.stopwatch;
  
  // å…¶ä»–çŠ¶æ€...

  @override
  void initState() {
    super.initState();
    logger.debug('HabitTrackingPageåˆå§‹åŒ–ï¼Œä¹ æƒ¯åç§°: ${widget.habit.name}');
    _initializeDescriptionController();
    
    // æ£€æŸ¥å¹¶æ¢å¤çŠ¶æ€
    _restoreFocusState();
    
    // æ·»åŠ ç›‘å¬å™¨
    widget.focusState.addListener(_onFocusStateChanged);
    widget.focusState.addTimeUpdateListener(_onTimeUpdate);
    widget.focusState.addCountdownEndListener(_onCountdownEnd);
  }
  
  void _restoreFocusState() {
    if (widget.focusState.focusStatus != FocusStatus.stop && 
        widget.focusState.currentFocusHabit != null &&
        widget.focusState.currentFocusHabit!.id == widget.habit.id) {
      setState(() {
        _focusStatus = widget.focusState.focusStatus;
        _showSettings = false;
        _elapsedTime = widget.focusState.elapsedTime;
        _selectedMode = widget.focusState.focusMode ?? TrackingMode.pomodoro;
      });
    }
  }
  
  // å®ç°å…¶ä»–æ–¹æ³•...
}

// 2. åœ¨ä¾èµ–æ³¨å…¥ä¸­æ³¨å†Œæˆ–ä½¿ç”¨Providerä¼ é€’
void _initHabitModule() {
  // å…¶ä»–æ³¨å†Œ...
  
  // æ³¨å†Œé¡µé¢å·¥å‚
  sl.registerFactory((_) => HabitTrackingPage(
    habit: sl(), // è¿è¡Œæ—¶æä¾›
    focusState: sl(),
    habitProvider: sl(),
  ));
}

// 3. ä½¿ç”¨StreamBuilderä»£æ›¿æ‰‹åŠ¨ç›‘å¬å™¨
class _HabitTrackingPageState extends State<HabitTrackingPage> {
  // ...
  
  @override
  Widget build(BuildContext context) {
    return StreamBuilder<Duration>(
      stream: widget.focusState.timeStream,
      builder: (context, timeSnapshot) {
        final elapsedTime = timeSnapshot.data ?? Duration.zero;
        
        return StreamBuilder<FocusStatus>(
          stream: widget.focusState.statusStream,
          builder: (context, statusSnapshot) {
            final focusStatus = statusSnapshot.data ?? FocusStatus.stop;
            
            return _buildUI(context, elapsedTime, focusStatus);
          },
        );
      },
    );
  }
  
  Widget _buildUI(BuildContext context, Duration elapsedTime, FocusStatus focusStatus) {
    // æ„å»ºUIç»„ä»¶
  }
}
```

### 10. ç»Ÿè®¡åŠŸèƒ½ä¼˜åŒ–

#### statistics_page.dartä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- é¡µé¢ä¸­åŒ…å«ç»Ÿè®¡è®¡ç®—é€»è¾‘ï¼Œåº”ç§»è‡³æœåŠ¡å±‚
- ç›´æ¥å®ä¾‹åŒ–HabitStatisticsServiceï¼Œè¿åä¾èµ–æ³¨å…¥åŸåˆ™
- UIçŠ¶æ€ç®¡ç†å’Œä¸šåŠ¡é€»è¾‘æ··åˆ

ä¼˜åŒ–å»ºè®®ï¼š
```dart
// 1. åˆ›å»ºç»Ÿè®¡ç”¨ä¾‹ç±»
class GetStatisticsUseCase {
  final HabitStatisticsService _statisticsService;
  
  GetStatisticsUseCase(this._statisticsService);
  
  Map<String, dynamic> getStatistics(List<Habit> habits, String period) {
    switch (period) {
      case 'week':
        return _statisticsService.getWeeklyHabitStatistics(habits);
      case 'month':
        return _statisticsService.getMonthlyHabitStatistics(habits);
      case 'year':
        return _statisticsService.getYearlyHabitStatistics(habits);
      default:
        return _statisticsService.getWeeklyHabitStatistics(habits);
    }
  }
}

// 2. åœ¨StatisticsProviderä¸­æ³¨å…¥ç”¨ä¾‹
class StatisticsProvider extends ChangeNotifier {
  final GetStatisticsUseCase _getStatisticsUseCase;
  
  StatisticsProvider(this._getStatisticsUseCase);
  
  // æ·»åŠ è·å–ç»Ÿè®¡æ•°æ®çš„æ–¹æ³•
  Map<String, dynamic> getStatistics(List<Habit> habits, String period) {
    return _getStatisticsUseCase.getStatistics(habits, period);
  }
}

// 3. ä¼˜åŒ–StatisticsPageï¼Œé€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
class StatisticsPage extends StatefulWidget {
  final StatisticsProvider statisticsProvider;
  final HabitProvider habitProvider;
  final GetStatisticsUseCase getStatisticsUseCase;
  
  const StatisticsPage({
    super.key,
    required this.statisticsProvider,
    required this.habitProvider,
    required this.getStatisticsUseCase,
  });
  
  @override
  State<StatisticsPage> createState() => _StatisticsPageState();
}

class _StatisticsPageState extends State<StatisticsPage> {
  late AnimationController _fadeAnimation;
  bool _isDetailView = true;
  String _statsTimeRange = 'week';
  
  // ç§»é™¤é¡µé¢ä¸­çš„ç»Ÿè®¡è®¡ç®—æ–¹æ³•
  
  void _sendProgressReport(BuildContext context) {
    final habits = widget.habitProvider.habits;
    
    // ä½¿ç”¨æ³¨å…¥çš„ç”¨ä¾‹è·å–ç»Ÿè®¡æ•°æ®
    final stats = widget.getStatisticsUseCase.getStatistics(habits, _statsTimeRange);
    
    // å¯¼èˆªåˆ°ç»Ÿè®¡æŠ¥å‘Šé¡µé¢
    AppRouter.router.go(
      '/statistics/result',
      extra: {
        'statisticsData': stats,
        'periodType': _statsTimeRange,
      },
    );
  }
  
  // å…¶ä»–æ–¹æ³•...
}

// 4. åœ¨ä¾èµ–æ³¨å…¥ä¸­æ³¨å†Œ
void _initStatisticsModule() {
  sl.registerFactory(() => GetStatisticsUseCase(sl()));
  
  sl.registerFactory(() => StatisticsProvider(sl()));
  
  sl.registerFactory(() => StatisticsPage(
    statisticsProvider: sl(),
    habitProvider: sl(),
    getStatisticsUseCase: sl(),
  ));
}
```

### 12. ä¸ªäººèµ„æ–™ç®¡ç†ä¼˜åŒ–

#### profile_page.dartä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- ç›´æ¥å¤„ç†SharedPreferencesæ“ä½œ
- ç¼ºä¹ç”¨æˆ·é…ç½®ç®¡ç†çš„æœåŠ¡å±‚æŠ½è±¡
- ä¸ªäººèµ„æ–™æ•°æ®ä¸UIæ··åˆ
- ç›´æ¥ä½¿ç”¨DebugMenuManagerï¼Œè¿åä¾èµ–æ³¨å…¥åŸåˆ™

ä¼˜åŒ–å»ºè®®ï¼š
```dart
// 1. åˆ›å»ºç”¨æˆ·é…ç½®æœåŠ¡æ¥å£
abstract class IUserProfileService {
  Future<UserProfile> getUserProfile();
  Future<void> updateUserProfile(UserProfile profile);
  Future<void> updateAvatar(String? avatarPath);
  Future<void> updateUsername(String username);
}

// 2. åˆ›å»ºç”¨æˆ·èµ„æ–™æ¨¡å‹
class UserProfile {
  final String username;
  final String? avatarPath;
  final bool dataBackupEnabled;
  final String backupFrequency;
  
  UserProfile({
    this.username = 'ç”¨æˆ·',
    this.avatarPath,
    this.dataBackupEnabled = false,
    this.backupFrequency = 'æ¯å‘¨',
  });
  
  UserProfile copyWith({
    String? username,
    String? avatarPath,
    bool? dataBackupEnabled,
    String? backupFrequency,
  }) {
    return UserProfile(
      username: username ?? this.username,
      avatarPath: avatarPath ?? this.avatarPath,
      dataBackupEnabled: dataBackupEnabled ?? this.dataBackupEnabled,
      backupFrequency: backupFrequency ?? this.backupFrequency,
    );
  }
}

// 3. å®ç°ç”¨æˆ·é…ç½®æœåŠ¡
class UserProfileServiceImpl implements IUserProfileService {
  final SharedPreferences _prefs;
  
  UserProfileServiceImpl(this._prefs);
  
  @override
  Future<UserProfile> getUserProfile() async {
    try {
      return UserProfile(
        username: _prefs.getString('username') ?? 'ç”¨æˆ·',
        avatarPath: _prefs.getString('avatarPath'),
        dataBackupEnabled: _prefs.getBool('dataBackupEnabled') ?? false,
        backupFrequency: _prefs.getString('backupFrequency') ?? 'æ¯å‘¨',
      );
    } catch (e) {
      logger.error('è·å–ç”¨æˆ·é…ç½®å¤±è´¥', e);
      return UserProfile();
    }
  }
  
  @override
  Future<void> updateUserProfile(UserProfile profile) async {
    try {
      await _prefs.setString('username', profile.username);
      await _prefs.setString('avatarPath', profile.avatarPath ?? '');
      await _prefs.setBool('dataBackupEnabled', profile.dataBackupEnabled);
      await _prefs.setString('backupFrequency', profile.backupFrequency);
    } catch (e) {
      logger.error('æ›´æ–°ç”¨æˆ·é…ç½®å¤±è´¥', e);
      throw UserProfileException('æ›´æ–°ç”¨æˆ·é…ç½®å¤±è´¥');
    }
  }
  
  @override
  Future<void> updateAvatar(String? avatarPath) async {
    final profile = await getUserProfile();
    await updateUserProfile(profile.copyWith(avatarPath: avatarPath));
  }
  
  @override
  Future<void> updateUsername(String username) async {
    final profile = await getUserProfile();
    await updateUserProfile(profile.copyWith(username: username));
  }
}

// 4. ä¼˜åŒ–ProfilePageï¼Œé€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
class ProfilePage extends StatefulWidget {
  final IUserProfileService profileService;
  final DebugMenuManager debugMenuManager;
  
  const ProfilePage({
    super.key,
    required this.profileService,
    required this.debugMenuManager,
  });
  
  @override
  State<ProfilePage> createState() => _ProfilePageState();
}

class _ProfilePageState extends State<ProfilePage> {
  late UserProfile _userProfile;
  bool _isLoading = true;
  
  @override
  void initState() {
    super.initState();
    _loadUserProfile();
    
    // æ·»åŠ è°ƒè¯•æ¨¡å¼ç›‘å¬å™¨
    widget.debugMenuManager.showDebugTabNotifier.addListener(_onDebugModeChanged);
  }
  
  Future<void> _loadUserProfile() async {
    try {
      _userProfile = await widget.profileService.getUserProfile();
    } catch (e) {
      _userProfile = UserProfile();
      logger.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥', e);
    } finally {
      setState(() => _isLoading = false);
    }
  }
  
  Future<void> _pickImage() async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(source: ImageSource.gallery);
    if (pickedFile != null) {
      try {
        await widget.profileService.updateAvatar(pickedFile.path);
        _userProfile = await widget.profileService.getUserProfile();
        setState(() {});
      } catch (e) {
        logger.error('æ›´æ–°å¤´åƒå¤±è´¥', e);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('æ›´æ–°å¤´åƒå¤±è´¥')),
        );
      }
    }
  }
  
  void _onDebugModeChanged() {
    if (mounted) {
      setState(() {});
    }
  }
  
  @override
  void dispose() {
    widget.debugMenuManager.showDebugTabNotifier.removeListener(_onDebugModeChanged);
    super.dispose();
  }
  
  @override
  Widget build(BuildContext context) {
    if (_isLoading) {
      return const Center(child: CircularProgressIndicator());
    }
    
    return Scaffold(
      // æ„å»ºUI...
    );
  }
}

// 5. åœ¨ä¾èµ–æ³¨å…¥ä¸­æ³¨å†Œ
void _initProfileModule() {
  sl.registerSingleton<IUserProfileService>(
    UserProfileServiceImpl(sl()),
  );
  
  sl.registerFactory(() => ProfilePage(
    profileService: sl(),
    debugMenuManager: sl(),
  ));
}
```

### 13. ä¸»é¢˜ç³»ç»Ÿä¼˜åŒ–

#### ThemeHelperå’ŒThemeProviderä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- ThemeHelperä½¿ç”¨é™æ€æ–¹æ³•è®¾è®¡ï¼Œéš¾ä»¥æµ‹è¯•å’Œæ‰©å±•
- ä¸»é¢˜ç›¸å…³åŠŸèƒ½åˆ†æ•£åœ¨å¤šä¸ªç±»ä¸­
- ç¼ºä¹ç»Ÿä¸€çš„ä¸»é¢˜è®¿é—®æ¥å£

ä¼˜åŒ–å»ºè®®ï¼š
```dart
// 1. åˆ›å»ºä¸»é¢˜æœåŠ¡æ¥å£
abstract class IThemeService {
  // ä¸»é¢˜çŠ¶æ€è®¿é—®
  app_theme.ThemeMode get themeMode;
  app_theme.AppTheme get currentTheme;
  List<app_theme.AppTheme> get availableThemes;
  bool get isDarkMode;
  
  // ä¸»é¢˜æ“ä½œ
  Future<void> setThemeMode(app_theme.ThemeMode mode);
  Future<void> setThemeByName(String themeName);
  Future<void> addCustomTheme(Color color);
  
  // é¢œè‰²å’Œæ ·å¼è®¿é—®
  Color primaryColor(BuildContext context);
  Color onPrimaryColor(BuildContext context);
  Color backgroundColor(BuildContext context);
  Color onBackgroundColor(BuildContext context);
  
  // è·å–é…ç½®å¥½çš„ç»„ä»¶æ ·å¼
  ButtonStyle elevatedButtonStyle(BuildContext context);
  ButtonStyle outlinedButtonStyle(BuildContext context);
  ButtonStyle textButtonStyle(BuildContext context);
}

// 2. å®ç°ä¸»é¢˜æœåŠ¡
class ThemeServiceImpl implements IThemeService {
  final SharedPreferences _preferences;
  app_theme.ThemeMode _themeMode = app_theme.ThemeMode.light;
  String _selectedThemeName = 'é»˜è®¤è“è‰²';
  List<app_theme.AppTheme> _availableThemes = app_theme.defaultAppThemes();
  
  ThemeServiceImpl(this._preferences) {
    _loadSettings();
  }
  
  @override
  app_theme.ThemeMode get themeMode => _themeMode;
  
  @override
  app_theme.AppTheme get currentTheme => _availableThemes.firstWhere(
    (theme) => theme.name == _selectedThemeName,
    orElse: () => _availableThemes[0],
  );
  
  @override
  Future<void> setThemeMode(app_theme.ThemeMode mode) async {
    if (_themeMode != mode) {
      _themeMode = mode;
      await _saveSettings();
    }
  }
  
  // å®ç°å…¶ä»–æ–¹æ³•...
  
  Future<void> _loadSettings() async {
    try {
      final themeModeStr = _preferences.getString('themeMode') ?? 'light';
      _selectedThemeName = _preferences.getString('selectedTheme') ?? 'é»˜è®¤è“è‰²';
      
      // è½¬æ¢ä¸»é¢˜æ¨¡å¼
      switch (themeModeStr) {
        case 'light':
          _themeMode = app_theme.ThemeMode.light;
          break;
        case 'dark':
          _themeMode = app_theme.ThemeMode.dark;
          break;
        case 'system':
          _themeMode = app_theme.ThemeMode.system;
          break;
        default:
          _themeMode = app_theme.ThemeMode.light;
      }
    } catch (e) {
      logger.error('åŠ è½½ä¸»é¢˜è®¾ç½®å¤±è´¥', e);
      // ä½¿ç”¨é»˜è®¤è®¾ç½®
    }
  }
  
  Future<void> _saveSettings() async {
    // ä¿å­˜è®¾ç½®é€»è¾‘
  }
}

// 3. ä¸ºProvideræä¾›ä¸»é¢˜æœåŠ¡
class ThemeProvider extends ChangeNotifier {
  final IThemeService _themeService;
  
  ThemeProvider(this._themeService);
  
  // ä»£ç†åˆ°ä¸»é¢˜æœåŠ¡çš„æ–¹æ³•
  app_theme.ThemeMode get themeMode => _themeService.themeMode;
  app_theme.AppTheme get currentTheme => _themeService.currentTheme;
  
  Future<void> setThemeMode(app_theme.ThemeMode mode) async {
    await _themeService.setThemeMode(mode);
    notifyListeners();
  }
  
  // å…¶ä»–ä»£ç†æ–¹æ³•...
}

// 4. åœ¨ä¾èµ–æ³¨å…¥ä¸­æ³¨å†Œ
void _initThemeSystem() {
  sl.registerSingleton<IThemeService>(
    ThemeServiceImpl(sl()),
  );
  
  sl.registerFactory(() => ThemeProvider(sl()));
}
### 14. è·¯ç”±æ¶æ„ä¼˜åŒ–

#### è·¯ç”±ç³»ç»Ÿä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- å¤šä¸ªè·¯ç”±æ˜ å°„åˆ°åŒä¸€ä¸ªé¡µé¢ç»„ä»¶
- è·¯ç”±å‚æ•°ä¼ é€’æ–¹å¼ä¸ä¸€è‡´
- è·¯ç”±é…ç½®ä¸é¡µé¢ç»„ä»¶è€¦åˆåº¦é«˜
- ç¼ºä¹è·¯ç”±å®ˆå«å’Œç»Ÿä¸€çš„å¯¼èˆªæœåŠ¡

ä¼˜åŒ–å»ºè®®ï¼š
```dart
// 1. åˆ›å»ºå¯¼èˆªæœåŠ¡æ¥å£
abstract class INavigationService {
  // åŸºæœ¬å¯¼èˆªæ–¹æ³•
  void navigateTo(String routeName, {dynamic extra});
  void push(String routeName, {dynamic extra});
  void pop();
  void goBack();
  
  // ç‰¹å®šåŠŸèƒ½å¯¼èˆª
  void navigateToHome();
  void navigateToHabitDetails(Habit habit);
  void navigateToStatistics();
  void navigateToProfile();
  
  // è·¯ç”±ä¿¡æ¯
  String get currentRoute;
}

// 2. å®ç°å¯¼èˆªæœåŠ¡
class NavigationServiceImpl implements INavigationService {
  @override
  void navigateTo(String routeName, {dynamic extra}) {
    AppRouter.router.go(routeName, extra: extra);
  }
  
  @override
  void push(String routeName, {dynamic extra}) {
    AppRouter.router.push(routeName, extra: extra);
  }
  
  @override
  void pop() {
    AppRouter.router.pop();
  }
  
  @override
  void goBack() {
    AppRouter.router.pop();
  }
  
  @override
  void navigateToHome() {
    AppRouter.router.go('/');
  }
  
  @override
  void navigateToHabitDetails(Habit habit) {
    AppRouter.router.push('/habits/tracking', extra: habit);
  }
  
  @override
  void navigateToStatistics() {
    AppRouter.router.push('/statistics');
  }
  
  @override
  void navigateToProfile() {
    AppRouter.router.push('/profile');
  }
  
  @override
  String get currentRoute => AppRouter.router.location;
}

// 3. ä¼˜åŒ–è·¯ç”±é…ç½®ï¼Œé¿å…è·¯ç”±é‡å¤
class StatisticsRoutes {
  static const String root = 'statistics';
  static const String details = 'statistics/details';
  static const String timeline = 'statistics/timeline';
  static const String result = 'statistics/result';

  static List<GoRoute> get routes => [
        GoRoute(
          path: root,
          builder: (context, state) {
            // æ ¹æ®å­è·¯å¾„å†³å®šæ˜¾ç¤ºä¸åŒè§†å›¾
            final pathSegments = state.uri.pathSegments;
            if (pathSegments.length > 1) {
              if (pathSegments[1] == 'details') {
                return StatisticsPage(initialView: StatisticsView.details);
              } else if (pathSegments[1] == 'timeline') {
                return StatisticsPage(initialView: StatisticsView.timeline);
              }
            }
            return StatisticsPage(initialView: StatisticsView.overview);
          },
        ),
        GoRoute(
          path: result,
          builder: (context, state) {
            final extra = state.extra as Map<String, dynamic>?;
            final statisticsData = extra?['statisticsData'] as Map<String, dynamic>?;
            final periodType = extra?['periodType'] as String?;
            return KeepAliveStatsResultPage(
              statisticsData: statisticsData,
              periodType: periodType,
            );
          },
        ),
      ];
}

// 4. ä¸ºStatisticsPageæ·»åŠ è§†å›¾ç±»å‹æšä¸¾
enum StatisticsView {
  overview,
  details,
  timeline,
}

class StatisticsPage extends StatefulWidget {
  final StatisticsView initialView;
  
  const StatisticsPage({super.key, this.initialView = StatisticsView.overview});
  
  @override
  State<StatisticsPage> createState() => _StatisticsPageState();
}

// 5. å®ç°è·¯ç”±å®ˆå«
class AuthGuard extends GoRouteData {
  @override
  FutureOr<String?> redirect(BuildContext context, GoRouterState state) {
    // æ£€æŸ¥æ˜¯å¦éœ€è¦è®¤è¯
    final isAuthenticated = true; // è¿™é‡Œåº”è¯¥æœ‰å®é™…çš„è®¤è¯æ£€æŸ¥é€»è¾‘
    
    if (!isAuthenticated && state.location != '/login') {
      return '/login';
    }
    
    return null;
  }
}

// 6. åœ¨ä¾èµ–æ³¨å…¥ä¸­æ³¨å†Œå¯¼èˆªæœåŠ¡
void _initNavigation() {
  sl.registerSingleton<INavigationService>(NavigationServiceImpl());
}
```

### 15. UIç»„ä»¶å…±äº«å’Œå·¥å…·ç±»ä¼˜åŒ–

#### å·¥å…·ç±»è®¾è®¡ä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- IconHelperä½¿ç”¨é™æ€æ–¹æ³•è®¾è®¡ï¼Œéš¾ä»¥æµ‹è¯•å’Œæ‰©å±•
- ä¸»é¢˜ç›¸å…³å·¥å…·ç±»å’Œå›¾æ ‡å·¥å…·ç±»åˆ†æ•£åœ¨ä¸åŒæ–‡ä»¶ä¸­
- å·¥å…·ç±»ç¼ºä¹ç»Ÿä¸€çš„æŠ½è±¡å’Œä¾èµ–æ³¨å…¥
- DebugMenuManagerä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œä¸ä¾èµ–æ³¨å…¥å®¹å™¨éš”ç¦»

ä¼˜åŒ–å»ºè®®ï¼š
```dart
// 1. åˆ›å»ºå›¾æ ‡æœåŠ¡æ¥å£
abstract class IIconService {
  IconData getIconData(String iconName, {bool logError = true});
  List<String> getIconCategories();
  List<String> getIconsByCategory(String category);
  bool hasIcon(String iconName);
}

// 2. å®ç°å›¾æ ‡æœåŠ¡
class IconServiceImpl implements IIconService {
  // å›¾æ ‡åˆ†ç±»æ˜ å°„è¡¨
  final Map<String, List<String>> _iconsByCategory = {
    'å­¦ä¹ ç±»': ['book', 'menu_book', 'school', /* ... */],
    // å…¶ä»–åˆ†ç±»...
  };
  
  // å›¾æ ‡æ˜ å°„è¡¨
  final Map<String, IconData> _iconMap = {
    'book': Icons.book,
    'menu_book': Icons.menu_book,
    // å…¶ä»–å›¾æ ‡...
  };
  
  @override
  IconData getIconData(String iconName, {bool logError = true}) {
    if (iconName.isEmpty) {
      return Icons.star; // é»˜è®¤å›¾æ ‡
    }
    
    final icon = _iconMap[iconName];
    if (icon != null) {
      return icon;
    }
    
    if (logError) {
      logger.warning('æœªæ‰¾åˆ°å›¾æ ‡: $iconNameï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡');
    }
    return Icons.star; // é»˜è®¤å›¾æ ‡
  }
  
  @override
  List<String> getIconCategories() {
    return _iconsByCategory.keys.toList();
  }
  
  @override
  List<String> getIconsByCategory(String category) {
    return _iconsByCategory[category] ?? [];
  }
  
  @override
  bool hasIcon(String iconName) {
    return _iconMap.containsKey(iconName);
  }
}

// 3. åˆ›å»ºUIå·¥å…·æœåŠ¡æ¥å£
abstract class IUiHelperService {
  // ä¸»é¢˜ç›¸å…³æ–¹æ³•
  Color primaryColor(BuildContext context);
  Color onPrimaryColor(BuildContext context);
  TextStyle textStyleWithTheme(BuildContext context, {double? fontSize, FontWeight? fontWeight, Color? color});
  ButtonStyle elevatedButtonStyle(BuildContext context);
  
  // å¸ƒå±€ç›¸å…³æ–¹æ³•
  EdgeInsets getDefaultPadding(BuildContext context);
  double getScreenWidth(BuildContext context);
  double getScreenHeight(BuildContext context);
  
  // é€šç”¨ç»„ä»¶åˆ›å»ºæ–¹æ³•
  Widget buildPrimaryButton(BuildContext context, String text, VoidCallback onPressed);
  Widget buildCard(BuildContext context, Widget child, {EdgeInsets? padding});
}

// 4. å®ç°UIå·¥å…·æœåŠ¡
class UiHelperServiceImpl implements IUiHelperService {
  @override
  Color primaryColor(BuildContext context) {
    return Theme.of(context).colorScheme.primary;
  }
  
  @override
  Color onPrimaryColor(BuildContext context) {
    return Theme.of(context).colorScheme.onPrimary;
  }
  
  @override
  TextStyle textStyleWithTheme(BuildContext context, {
    double? fontSize,
    FontWeight? fontWeight,
    Color? color,
  }) {
    return TextStyle(
      fontSize: fontSize,
      fontWeight: fontWeight,
      color: color ?? Theme.of(context).colorScheme.onSurface,
    );
  }
  
  @override
  ButtonStyle elevatedButtonStyle(BuildContext context) {
    return ElevatedButton.styleFrom(
      backgroundColor: primaryColor(context),
      foregroundColor: onPrimaryColor(context),
    );
  }
  
  @override
  EdgeInsets getDefaultPadding(BuildContext context) {
    return EdgeInsets.all(16);
  }
  
  @override
  double getScreenWidth(BuildContext context) {
    return MediaQuery.of(context).size.width;
  }
  
  @override
  double getScreenHeight(BuildContext context) {
    return MediaQuery.of(context).size.height;
  }
  
  @override
  Widget buildPrimaryButton(BuildContext context, String text, VoidCallback onPressed) {
    return ElevatedButton(
      style: elevatedButtonStyle(context),
      onPressed: onPressed,
      child: Text(text),
    );
  }
  
  @override
  Widget buildCard(BuildContext context, Widget child, {EdgeInsets? padding}) {
    return Card(
      margin: getDefaultPadding(context),
      padding: padding ?? getDefaultPadding(context),
      child: child,
    );
  }
}

// 5. åœ¨ä¾èµ–æ³¨å…¥ä¸­æ³¨å†ŒæœåŠ¡
void _initUiServices() {
  sl.registerSingleton<IIconService>(IconServiceImpl());
  sl.registerSingleton<IUiHelperService>(UiHelperServiceImpl());
}

// 6. åœ¨UIç»„ä»¶ä¸­ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æœåŠ¡
class TimelineViewWidget extends StatelessWidget {
  final List<Habit> habits;
  final int selectedYear;
  final int selectedMonth;
  final IIconService iconService;
  
  const TimelineViewWidget({
    super.key,
    required this.habits,
    required this.selectedYear,
    required this.selectedMonth,
    required this.iconService,
  });
  
  @override
  Widget build(BuildContext context) {
    // ä½¿ç”¨iconServiceæ›¿ä»£é™æ€IconHelper
    final icon = iconService.getIconData('book');
    
    // å…¶ä»–å®ç°...
  }
}
```

### 16. å•ä¾‹æ¨¡å¼å’Œè°ƒè¯•åŠŸèƒ½ä¼˜åŒ–

#### DebugMenuManagerä¼˜åŒ–

å½“å‰é—®é¢˜ï¼š
- ä½¿ç”¨ç¡¬ç¼–ç çš„å•ä¾‹æ¨¡å¼ï¼Œä¸ä¾èµ–æ³¨å…¥å®¹å™¨éš”ç¦»
- ç›´æ¥åœ¨ç±»å†…éƒ¨ä½¿ç”¨æœåŠ¡å®šä½å™¨è·å–ä¾èµ–
- ç”Ÿå‘½å‘¨æœŸç®¡ç†ä¸è§„èŒƒï¼Œåœ¨æ„é€ å‡½æ•°ä¸­æ·»åŠ ç›‘å¬å™¨
- ä¸SharedPreferencesäº¤äº’æ²¡æœ‰æŠ½è±¡å±‚
- HabitDataGeneratorç±»ä¹Ÿä½¿ç”¨é™æ€æ–¹æ³•è®¾è®¡ï¼Œä¸ä¾èµ–æ³¨å…¥éš”ç¦»

ä¼˜åŒ–å»ºè®®ï¼š
```dart
// 1. åˆ›å»ºè°ƒè¯•æœåŠ¡æ¥å£
abstract class IDebugService {
  bool get isDebugModeActive;
  bool get showDebugTab;
  ValueNotifier<bool> get showDebugTabNotifier;
  
  void recordTap(BuildContext context);
  void toggleDebugTab();
  Future<void> deactivateDebugMode();
  void resetDebugTab();
  Widget buildDebugTab(BuildContext context);
}

// 2. å®ç°è°ƒè¯•æœåŠ¡
class DebugServiceImpl implements IDebugService {
  static const String _debugModeKey = 'debug_mode_active';
  static const int _tapCountThreshold = 5;
  static const Duration _tapTimeout = Duration(seconds: 1);
  
  final SharedPreferences _prefs;
  final AddHabitUseCase _addHabitUseCase;
  final HabitDataGenerator _habitDataGenerator;
  
  bool _isDebugModeActive = false;
  int _tapCount = 0;
  DateTime? _lastTapTime;
  BuildContext? _context;
  bool _showDebugTab = false;
  
  @override
  final ValueNotifier<bool> showDebugTabNotifier = ValueNotifier(false);
  
  DebugServiceImpl(this._prefs, this._addHabitUseCase, this._habitDataGenerator) {
    _checkDebugModeStatus();
  }
  
  @override
  bool get isDebugModeActive => _isDebugModeActive;
  
  @override
  bool get showDebugTab => _showDebugTab;
  
  @override
  void recordTap(BuildContext context) {
    final now = DateTime.now();
    
    if (_lastTapTime == null || now.difference(_lastTapTime!).compareTo(_tapTimeout) > 0) {
      _tapCount = 0;
    }
    
    _tapCount++;
    _lastTapTime = now;
    _context = context;
    
    if (_tapCount >= _tapCountThreshold && !_isDebugModeActive) {
      _activateDebugMode();
    }
  }
  
  @override
  void toggleDebugTab() {
    _isDebugModeActive = true;
    _showDebugTab = true;
    showDebugTabNotifier.value = true;
    _prefs.setBool(_debugModeKey, true);
  }
  
  @override
  Future<void> deactivateDebugMode() async {
    _isDebugModeActive = false;
    _showDebugTab = false;
    showDebugTabNotifier.value = false;
    await _prefs.setBool(_debugModeKey, false);
  }
  
  @override
  void resetDebugTab() {
    _showDebugTab = false;
    showDebugTabNotifier.value = false;
  }
  
  Future<void> _checkDebugModeStatus() async {
    _isDebugModeActive = false;
    _showDebugTab = false;
    showDebugTabNotifier.value = false;
    await _prefs.setBool(_debugModeKey, false);
  }
  
  void _activateDebugMode() {
    _isDebugModeActive = true;
    _showDebugTab = true;
    showDebugTabNotifier.value = true;
    _prefs.setBool(_debugModeKey, true);
    _showToast('Debugæ¨¡å¼å·²æ¿€æ´»');
  }
  
  void _showToast(String message) {
    if (_context != null) {
      // æ˜¾ç¤ºToastæ¶ˆæ¯...
    }
  }
  
  @override
  Widget buildDebugTab(BuildContext context) {
    _context = context;
    // æ„å»ºè°ƒè¯•é¡µé¢...
    return Scaffold(
      // å®ç°...
    );
  }
}

// 3. åˆ›å»ºä¹ æƒ¯æ•°æ®ç”Ÿæˆå™¨æ¥å£
abstract class IHabitDataGenerator {
  List<Habit> generateMockHabits(int count);
  Habit generateRandomHabit();
}

// 4. åœ¨ä¾èµ–æ³¨å…¥ä¸­æ³¨å†Œ
void _initDebugServices() {
  sl.registerSingleton<IHabitDataGenerator>(HabitDataGenerator());
  sl.registerSingleton<IDebugService>(
    DebugServiceImpl(
      sl(), // SharedPreferences
      sl(), // AddHabitUseCase
      sl(), // IHabitDataGenerator
    ),
  );
}

// 5. åœ¨ProfilePageä¸­ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æœåŠ¡
class ProfilePage extends StatefulWidget {
  final IDebugService debugService;
  
  const ProfilePage({super.key, required this.debugService});
  
  @override
  State<ProfilePage> createState() => _ProfilePageState();
}

class _ProfilePageState extends State<ProfilePage> {
  @override
  void initState() {
    super.initState();
    widget.debugService.showDebugTabNotifier.addListener(_onDebugModeChanged);
  }
  
  void _onDebugModeChanged() {
    if (mounted) {
      setState(() {});
    }
  }
  
  @override
  void dispose() {
    widget.debugService.showDebugTabNotifier.removeListener(_onDebugModeChanged);
    super.dispose();
  }
}
```

### 17. æ¶æ„ä¼˜åŒ–æ€»ç»“ä¸å®æ–½è·¯çº¿å›¾

#### æ•´ä½“æ¶æ„ä¼˜åŒ–å»ºè®®

åŸºäºå¯¹Contrailåº”ç”¨çš„å…¨é¢åˆ†æï¼Œæˆ‘ä»¬å·²ç»è¯†åˆ«å¹¶æä¾›äº†é’ˆå¯¹16ä¸ªå…³é”®æ¶æ„é—®é¢˜çš„ä¼˜åŒ–å»ºè®®ã€‚ä»¥ä¸‹æ˜¯æ•´ä½“æ¶æ„ä¼˜åŒ–çš„æ ¸å¿ƒæ€è·¯ï¼š

1. **æœåŠ¡å±‚é‡æ„**
   - ä¸ºæ‰€æœ‰æœåŠ¡åˆ›å»ºæŠ½è±¡æ¥å£ï¼ˆIIconService, IColorService, IUiHelperService, IDebugServiceç­‰ï¼‰
   - å°†é™æ€å·¥å…·ç±»è½¬æ¢ä¸ºä¾èµ–æ³¨å…¥çš„æœåŠ¡ï¼ˆIconHelper, ColorHelper, ThemeHelperç­‰ï¼‰
   - ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•æœºåˆ¶

2. **çŠ¶æ€ç®¡ç†ä¼˜åŒ–**
   - å°†Provideræ‹†åˆ†ä¸ºçº¯çŠ¶æ€ç±»å’Œä¸šåŠ¡é€»è¾‘ç±»ï¼ˆUseCaseï¼‰
   - ç»Ÿä¸€çŠ¶æ€æ¨¡å‹ï¼Œæ ‡å‡†åŒ–åŠ è½½ã€æˆåŠŸã€é”™è¯¯çŠ¶æ€å¤„ç†
   - æ¶ˆé™¤æœåŠ¡å®šä½å™¨æ¨¡å¼ï¼Œæ”¹ç”¨æ„é€ å‡½æ•°æ³¨å…¥

3. **UIå±‚ä¼˜åŒ–**
   - åˆ†ç¦»UIå’Œä¸šåŠ¡é€»è¾‘ï¼Œé¿å…é¡µé¢ç»„ä»¶åŒ…å«è¿‡å¤šä¸šåŠ¡ä»£ç 
   - åˆ›å»ºå¯é‡ç”¨çš„UIç»„ä»¶åº“ï¼Œå‡å°‘ä»£ç é‡å¤
   - ä¼˜åŒ–é¡µé¢é—´é€šä¿¡ï¼Œä½¿ç”¨å¯¼èˆªæœåŠ¡è€Œéç›´æ¥è·¯ç”±è°ƒç”¨

4. **æ•°æ®å±‚ä¼˜åŒ–**
   - å®Œå–„Hiveé€‚é…å™¨è®¾è®¡ï¼Œä½¿ç”¨code generationè€Œéæ‰‹åŠ¨ç¼–å†™
   - åˆ†ç¦»æŒä¹…åŒ–é€»è¾‘åˆ°ä¸“é—¨çš„å­˜å‚¨æœåŠ¡
   - å®ç°æ•°æ®è¿ç§»æœºåˆ¶ï¼Œæ”¯æŒç‰ˆæœ¬æ¼”è¿›

5. **ä¾èµ–æ³¨å…¥ç»„ç»‡**
   - æŒ‰æ¨¡å—åˆ†ç»„ä¾èµ–æ³¨å†Œ
   - ç¡®ä¿ä¾èµ–é¡ºåºæ­£ç¡®ï¼Œé¿å…å¾ªç¯ä¾èµ–
   - å‡å°‘å¯¹å…¨å±€æœåŠ¡å®šä½å™¨çš„ç›´æ¥ä½¿ç”¨

#### ä¼˜åŒ–å®æ–½è·¯çº¿å›¾

**ç¬¬1-2å‘¨ï¼šåŸºç¡€è®¾æ–½ä¼˜åŒ–**
- é‡æ„ä¾èµ–æ³¨å…¥å®¹å™¨ï¼ŒæŒ‰æ¨¡å—ç»„ç»‡ä¾èµ–
- åˆ›å»ºæ ¸å¿ƒæœåŠ¡æ¥å£ï¼ˆINavigationService, ILoggerServiceç­‰ï¼‰
- å®ç°ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶

**ç¬¬3-4å‘¨ï¼šæœåŠ¡å±‚é‡æ„**
- é‡æ„å·¥å…·ç±»ä¸ºä¾èµ–æ³¨å…¥æœåŠ¡
- å®ç°UIè¾…åŠ©æœåŠ¡ï¼ˆIUiHelperService, IIconService, IColorServiceï¼‰
- é‡æ„è°ƒè¯•æœåŠ¡ï¼ˆIDebugServiceï¼‰

**ç¬¬5-6å‘¨ï¼šçŠ¶æ€ç®¡ç†å±‚ä¼˜åŒ–**
- é‡æ„Providerä¸ºçº¯çŠ¶æ€ç±»
- å®Œå–„UseCaseæ¨¡å¼ï¼Œè¿ç§»ä¸šåŠ¡é€»è¾‘
- ä¼˜åŒ–FocusStateï¼Œå®ç°è§‚å¯Ÿè€…æ¨¡å¼çš„ä¼˜é›…å®ç°

**ç¬¬7-8å‘¨ï¼šUIå±‚ä¼˜åŒ–**
- é‡æ„é¡µé¢ç»„ä»¶ï¼Œç§»é™¤ä¸šåŠ¡é€»è¾‘
- å®ç°å¯¼èˆªæœåŠ¡å’Œè·¯ç”±å®ˆå«
- åˆ›å»ºå¯é‡ç”¨ç»„ä»¶åº“

**ç¬¬9å‘¨ï¼šæµ‹è¯•ä¸ä¼˜åŒ–**
- ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿åŠŸèƒ½æ­£ç¡®æ€§
- æ€§èƒ½ä¼˜åŒ–å’Œå†…å­˜æ³„æ¼ä¿®å¤
- ä»£ç å®¡æŸ¥å’Œæ–‡æ¡£å®Œå–„

#### æ¶æ„æ¼”è¿›å»ºè®®

éšç€åº”ç”¨è§„æ¨¡çš„å¢é•¿ï¼Œè€ƒè™‘ä»¥ä¸‹æ¶æ„æ¼”è¿›æ–¹å‘ï¼š

1. **é‡‡ç”¨æ›´æˆç†Ÿçš„çŠ¶æ€ç®¡ç†è§£å†³æ–¹æ¡ˆ**
   - è€ƒè™‘ä½¿ç”¨Blocã€Riverpodæˆ–GetXç­‰æ›´æˆç†Ÿçš„çŠ¶æ€ç®¡ç†åº“
   - å®ç°çŠ¶æ€æŒä¹…åŒ–å’Œæ¢å¤æœºåˆ¶

2. **æ¨¡å—åŒ–å’Œå¾®å‰ç«¯**
   - æŒ‰åŠŸèƒ½æ¨¡å—æ‹†åˆ†ä»£ç åº“
   - è€ƒè™‘ä½¿ç”¨Flutteræ¨¡å—æˆ–åŒ…ç®¡ç†æ¥éš”ç¦»åŠŸèƒ½

3. **æ•°æ®å±‚ä¼˜åŒ–**
   - å¼•å…¥æ•°æ®ç¼“å­˜å±‚ï¼Œå‡å°‘å¯¹Hiveçš„ç›´æ¥è®¿é—®
   - å®ç°æ•°æ®åŒæ­¥æœºåˆ¶ï¼Œæ”¯æŒå¤šè®¾å¤‡åŒæ­¥

4. **æµ‹è¯•ç­–ç•¥**
   - å®Œå–„å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’ŒUIæµ‹è¯•
   - å®ç°è‡ªåŠ¨åŒ–æµ‹è¯•æµæ°´çº¿

## æ€»ç»“

é€šè¿‡å¯¹Contrailåº”ç”¨çš„ä»£ç åˆ†æï¼Œæˆ‘ä»¬å‘ç°äº†å¤šä¸ªå¯ä»¥ä¼˜åŒ–çš„æ–¹é¢ï¼Œä¸»è¦åŒ…æ‹¬ä¸šåŠ¡é€»è¾‘ä¸UIçŠ¶æ€æ··åˆã€ç¼ºä¹æ¥å£æŠ½è±¡ã€æŒä¹…åŒ–é€»è¾‘æ··åˆåœ¨çŠ¶æ€ç±»ä¸­ã€é”™è¯¯å¤„ç†åˆ†æ•£ã€æ—¥å¿—ç³»ç»Ÿä¸é”™è¯¯å¤„ç†é›†æˆä¸è¶³ã€ä»£ç ç»“æ„é—®é¢˜ã€ç»„ä»¶é—´é€šä¿¡ä¸è§„èŒƒã€æ¶æ„ä¸€è‡´æ€§ä¸è¶³ã€å…¨å±€çŠ¶æ€ç®¡ç†é—®é¢˜ä»¥åŠæ•°æ®å¤‡ä»½æ¶æ„é—®é¢˜ç­‰ã€‚

æ‰€æœ‰æå‡ºçš„ä¼˜åŒ–å»ºè®®éƒ½é¿å…äº†è¿‡åº¦è®¾è®¡ï¼Œä¸“æ³¨äºè§£å†³å®é™…é—®é¢˜ï¼Œæ—¨åœ¨ä½¿ä»£ç æ›´åŠ å¥å£®ã€çµæ´»ï¼Œä¾¿äºåç»­è¿­ä»£å¼€å‘ã€‚ä¸»è¦ä¼˜åŒ–æ–¹å‘åŒ…æ‹¬ï¼š

1. **æœåŠ¡å±‚ä¼˜åŒ–**ï¼šåˆ›å»ºæŠ½è±¡æ¥å£ã€æ‹†åˆ†å¤æ‚æœåŠ¡
2. **çŠ¶æ€ç®¡ç†ä¼˜åŒ–**ï¼šåˆ†ç¦»ä¸šåŠ¡é€»è¾‘ä¸çŠ¶æ€ç®¡ç†ã€ç»Ÿä¸€çŠ¶æ€æ¨¡å‹
3. **ä¾èµ–æ³¨å…¥ä¼˜åŒ–**ï¼šæŒ‰æ¨¡å—ç»„ç»‡ä¾èµ–æ³¨å†Œ
4. **é”™è¯¯å¤„ç†ä¼˜åŒ–**ï¼šå®ç°ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
5. **ä»£ç è´¨é‡ä¼˜åŒ–**ï¼šé‡æ„é•¿æ–¹æ³•ã€æ¶ˆé™¤ä»£ç é‡å¤ã€ä¼˜åŒ–æ¨¡å‹ç±»
6. **ç»„ä»¶é—´é€šä¿¡ä¼˜åŒ–**ï¼šä½¿ç”¨ä¾èµ–æ³¨å…¥æ›¿ä»£é™æ€æ–¹æ³•å’Œä¾èµ–æŸ¥æ‰¾
7. **æŒä¹…åŒ–å±‚ä¼˜åŒ–**ï¼šåˆ†ç¦»çŠ¶æ€ç®¡ç†å’Œæ•°æ®æŒä¹…åŒ–é€»è¾‘

### è¯¦ç»†æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ

ä¸ºäº†æä¾›æ›´å…·ä½“çš„å®æ–½æŒ‡å¯¼ï¼Œæˆ‘ä»¬åˆ›å»ºäº†è¯¦ç»†çš„ç³»ç»Ÿæ¶æ„ä¼˜åŒ–æ–¹æ¡ˆæ–‡æ¡£ï¼ŒåŒ…å«ï¼š

1. **æ¨¡å—çº§æ¶æ„ä¼˜åŒ–**ï¼šä¸ºä¹ æƒ¯ç®¡ç†ã€ç»Ÿè®¡åŠŸèƒ½ã€ä¸“æ³¨åŠŸèƒ½ç­‰æ ¸å¿ƒæ¨¡å—æä¾›äº†å…·ä½“çš„é‡æ„æ–¹æ¡ˆ
2. **è·¨æ¨¡å—åŸºç¡€è®¾æ–½ä¼˜åŒ–**ï¼šè¯¦ç»†çš„ä¾èµ–æ³¨å…¥å®¹å™¨é‡æ„ã€é”™è¯¯å¤„ç†ç³»ç»Ÿé›†æˆã€æ•°æ®æŒä¹…åŒ–æŠ½è±¡å±‚è®¾è®¡
3. **UIç»„ä»¶æ¶æ„ä¼˜åŒ–**ï¼šç»„ä»¶å±‚æ¬¡ç»“æ„è®¾è®¡å’Œå¯¼èˆªæœåŠ¡ä¼˜åŒ–
4. **æ¸è¿›å¼å®æ–½ç­–ç•¥**ï¼šæŒ‰ä¼˜å…ˆçº§æ’åºçš„å®æ–½è®¡åˆ’å’Œè¯„ä¼°æŒ‡æ ‡

è¯¦ç»†å†…å®¹è¯·å‚è€ƒ <mcfile name="ç³»ç»Ÿæ¶æ„ä¼˜åŒ–è¯¦ç»†æ–¹æ¡ˆ.md" path="/Users/bytedance/traeProjects/Contrail/docs/ç³»ç»Ÿæ¶æ„ä¼˜åŒ–è¯¦ç»†æ–¹æ¡ˆ.md"></mcfile> æ–‡æ¡£ã€‚

### æ¶æ„ä¼˜åŒ–è·¯çº¿å›¾

åŸºäºå¯¹æ‰€æœ‰åˆ†ææ–‡ä»¶çš„è¯„ä¼°ï¼Œå»ºè®®æŒ‰ç…§ä»¥ä¸‹è·¯çº¿å›¾å®æ–½æ¶æ„ä¼˜åŒ–ï¼š

#### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½ä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰
- ä¸ºæ ¸å¿ƒæœåŠ¡åˆ›å»ºæŠ½è±¡æ¥å£ï¼ˆINotificationService, IBackgroundTimerServiceç­‰ï¼‰
- å®ç°ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶å’Œé”™è¯¯ç±»å±‚æ¬¡ç»“æ„
- æŒ‰æ¨¡å—ç»„ç»‡ä¾èµ–æ³¨å…¥æ³¨å†Œ
- åˆ›å»ºåŸºæœ¬çš„æ•°æ®æŒä¹…åŒ–æœåŠ¡å±‚ï¼ˆç”¨äºSharedPreferencesç­‰ï¼‰

#### ç¬¬äºŒé˜¶æ®µï¼šçŠ¶æ€ç®¡ç†å±‚ä¼˜åŒ–ï¼ˆ2-3å‘¨ï¼‰
- å®Œæˆæ‰€æœ‰UseCaseæ¨¡å¼çš„å®ç°ï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘ä¸çŠ¶æ€ç®¡ç†åˆ†ç¦»
- ç»Ÿä¸€çŠ¶æ€æ¨¡å‹ï¼Œå®ç°æ ‡å‡†çš„åŠ è½½/æˆåŠŸ/é”™è¯¯çŠ¶æ€å¤„ç†
- é‡æ„ThemeProviderï¼Œå°†æŒä¹…åŒ–é€»è¾‘ç§»è‡³æœåŠ¡å±‚
- ä¼˜åŒ–FocusStateï¼Œä½¿ç”¨Streamæ›¿ä»£è‡ªå®šä¹‰è§‚å¯Ÿè€…æ¨¡å¼

#### ç¬¬ä¸‰é˜¶æ®µï¼šUIå±‚ä¼˜åŒ–ï¼ˆ2å‘¨ï¼‰
- é‡æ„main_tab_page.dartï¼Œä½¿ç”¨ä¾èµ–æ³¨å…¥æ›¿ä»£é™æ€æ–¹æ³•å’Œä¾èµ–æŸ¥æ‰¾
- ç§»é™¤é¡µé¢ä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œç§»è‡³UseCaseæˆ–æœåŠ¡å±‚
- ç®€åŒ–é¡µé¢ç»„ä»¶ï¼Œæé«˜å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§

#### ç¬¬å››é˜¶æ®µï¼šä»£ç æ¸…ç†ä¸æµ‹è¯•ï¼ˆ1-2å‘¨ï¼‰
- ç§»é™¤æ‰€æœ‰æ³¨é‡Šæ‰çš„ä»£ç 
- ä¸ºæ ¸å¿ƒåŠŸèƒ½ç¼–å†™å•å…ƒæµ‹è¯•
- éªŒè¯æ‰€æœ‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ
- æ€§èƒ½ä¼˜åŒ–å’Œæœ€ç»ˆè°ƒæ•´

### æ”¶ç›Šé¢„æœŸ

é€šè¿‡å®æ–½ä¸Šè¿°ä¼˜åŒ–ï¼ŒContrailåº”ç”¨å°†è·å¾—ä»¥ä¸‹æ”¶ç›Šï¼š

1. **æé«˜å¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„åˆ†å±‚æ¶æ„ä½¿ä»£ç æ›´å®¹æ˜“ç†è§£å’Œç»´æŠ¤
2. **å¢å¼ºå¯æµ‹è¯•æ€§**ï¼šæ¥å£æŠ½è±¡å’Œä¾èµ–æ³¨å…¥ä½¿å•å…ƒæµ‹è¯•æ›´åŠ ç®€å•
3. **æå‡å¼€å‘æ•ˆç‡**ï¼šæ ‡å‡†åŒ–çš„æ¨¡å¼å’Œç»“æ„ä½¿æ–°åŠŸèƒ½å¼€å‘æ›´å¿«
4. **å‡å°‘bug**ï¼šèŒè´£åˆ†ç¦»å’Œç»Ÿä¸€é”™è¯¯å¤„ç†å‡å°‘æ½œåœ¨é—®é¢˜
5. **æ›´å¥½çš„æ‰©å±•æ€§**ï¼šæ¸…æ™°çš„æŠ½è±¡å’Œæ¨¡å—è¾¹ç•Œä½¿æ·»åŠ æ–°åŠŸèƒ½æ›´å®¹æ˜“

æ‰€æœ‰ä¼˜åŒ–å»ºè®®éƒ½è€ƒè™‘äº†åº”ç”¨çš„å½“å‰çŠ¶æ€å’Œè§„æ¨¡ï¼Œé¿å…äº†è¿‡åº¦å·¥ç¨‹åŒ–ï¼Œç¡®ä¿åœ¨ä¿æŒåŠŸèƒ½æ­£å¸¸çš„åŒæ—¶å®ç°æ¶æ„çš„æŒç»­æ”¹è¿›ã€‚